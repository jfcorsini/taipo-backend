{
  #set ($delimiter = "_")
  #set($chatId = $util.autoId())
  #set($timestamp = $util.time.nowISO8601())
  #set($chatName = $ctx.args.input.chatName)
  #set($usernames = $ctx.args.input.usernames)
  #set($identityUsername = $ctx.identity.username)

  "version" : "2018-05-29",
  "operation" : "BatchPutItem",
  "tables": {
    "${chatsTableName}": [
      {
        "chatId": $util.dynamodb.toStringJson($chatId),
        "sortKey": $util.dynamodb.toStringJson("config"),
        "chatName": $util.dynamodb.toStringJson($chatName),
        "createdAt": $util.dynamodb.toStringJson($timestamp),
        "private": $util.dynamodb.toBooleanJson(false)
      }
      ,{
        "chatId": $util.dynamodb.toStringJson($chatId),
        "sortKey": $util.dynamodb.toStringJson("member$delimiter$identityUsername"),
        "username": $util.dynamodb.toStringJson($identityUsername),
        "chatName": $util.dynamodb.toStringJson($chatName),
        "createdAt": $util.dynamodb.toStringJson($timestamp)
      }
      #foreach( $username in $usernames )
        ,{
          "chatId": $util.dynamodb.toStringJson($chatId),
          "sortKey": $util.dynamodb.toStringJson("member$delimiter$username"),
          "username": $util.dynamodb.toStringJson($username),
          "chatName": $util.dynamodb.toStringJson($chatName),
          "createdAt": $util.dynamodb.toStringJson($timestamp)
        }
      #end
    ]
  }
  }
}